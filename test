package com.hsbc.ccaas.papi.service.impl;

import com.hsbc.ccaas.papi.controller.model.ApprovalData;
import com.hsbc.ccaas.papi.controller.model.ApprovalResponse;
import com.hsbc.ccaas.papi.model.sapi.PendingChangeStatus;
import com.hsbc.ccaas.papi.model.sapi.PendingChangeVo;
import com.hsbc.ccaas.papi.model.sapi.ResponseEnvelope;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.ArgumentCaptor;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.core.ParameterizedTypeReference;
import org.springframework.http.MediaType;
import org.springframework.web.client.RestClient;

import java.time.LocalDateTime;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.*;
import static org.mockito.Mockito.*;

@ExtendWith(MockitoExtension.class)
class ChangeApprovalServiceImplTest {

    @Mock
    private RestClient sapiRestClient;

    @Mock
    private RestClient.RequestBodyUriSpec requestBodyUriSpec;

    @Mock
    private RestClient.RequestBodySpec requestBodySpec;

    @Mock
    private RestClient.ResponseSpec responseSpec;

    private ChangeApprovalServiceImpl service;

    @BeforeEach
    void setup() {
        // basePath will become: {prefix}/change-approvals
        service = new ChangeApprovalServiceImpl(sapiRestClient, "/sapi/v1");
    }

    @Test
    void approve_shouldReturnApprovedData_whenStatusApproved() {
        // given
        PendingChangeVo pendingChangeVo = new PendingChangeVo();
        pendingChangeVo.setIdentifier("ID-123");
        pendingChangeVo.setStatusCode(PendingChangeStatus.APPROVED);

        LocalDateTime appliedTime = LocalDateTime.now();
        pendingChangeVo.setLlReviewedAtDatetime(appliedTime);

        ResponseEnvelope<PendingChangeVo> envelope = new ResponseEnvelope<>();
        envelope.setData(pendingChangeVo);

        when(sapiRestClient.post()).thenReturn(requestBodyUriSpec);
        when(requestBodyUriSpec.uri(anyString())).thenReturn(requestBodySpec);
        when(requestBodySpec.body(any())).thenReturn(requestBodySpec);
        when(requestBodySpec.accept(MediaType.APPLICATION_JSON)).thenReturn(requestBodySpec);
        when(requestBodySpec.retrieve()).thenReturn(responseSpec);
        when(responseSpec.body(any(ParameterizedTypeReference.class))).thenReturn(envelope);

        // when
        ApprovalResponse response = service.approve(new com.hsbc.ccaas.papi.controller.model.ApproveChangeRequest());

        // then
        assertNotNull(response);
        assertNotNull(response.getData());

        ApprovalData approvalData = response.getData();
        assertEquals("ID-123", approvalData.getChangeIdentifier());
        assertEquals(Boolean.TRUE, approvalData.getSuccessIndicator());
        assertEquals(PendingChangeStatus.APPROVED, approvalData.getNewStatusCode());
        assertEquals("Change approved and applied", approvalData.getMessageText());
        assertEquals(appliedTime, approvalData.getAppliedDateTime());
        assertNull(approvalData.getEscalatedDateTime());

        // verify correct URI called
        verify(requestBodyUriSpec).uri("/sapi/v1/change-approvals");
    }

    @Test
    void approve_shouldReturnEscalatedData_whenStatusPendingLevelTwo() {
        // given
        PendingChangeVo pendingChangeVo = new PendingChangeVo();
        pendingChangeVo.setIdentifier("ID-999");
        pendingChangeVo.setStatusCode(PendingChangeStatus.PENDING_LEVEL_TWO);

        LocalDateTime reviewedTime = LocalDateTime.now();
        pendingChangeVo.setLlReviewedAtDatetime(reviewedTime);

        ResponseEnvelope<PendingChangeVo> envelope = new ResponseEnvelope<>();
        envelope.setData(pendingChangeVo);

        when(sapiRestClient.post()).thenReturn(requestBodyUriSpec);
        when(requestBodyUriSpec.uri(anyString())).thenReturn(requestBodySpec);
        when(requestBodySpec.body(any())).thenReturn(requestBodySpec);
        when(requestBodySpec.accept(MediaType.APPLICATION_JSON)).thenReturn(requestBodySpec);
        when(requestBodySpec.retrieve()).thenReturn(responseSpec);
        when(responseSpec.body(any(ParameterizedTypeReference.class))).thenReturn(envelope);

        // when
        ApprovalResponse response = service.approve(new com.hsbc.ccaas.papi.controller.model.ApproveChangeRequest());

        // then
        assertNotNull(response);
        assertNotNull(response.getData());

        ApprovalData approvalData = response.getData();
        assertEquals("ID-999", approvalData.getChangeIdentifier());
        assertEquals(Boolean.TRUE, approvalData.getSuccessIndicator());
        assertEquals(PendingChangeStatus.PENDING_LEVEL_TWO, approvalData.getNewStatusCode());
        assertEquals("L1 approved - escalated to Super Admin for L2 approval", approvalData.getMessageText());
        assertEquals(reviewedTime, approvalData.getEscalatedDateTime());
        assertNull(approvalData.getAppliedDateTime());

        verify(requestBodyUriSpec).uri("/sapi/v1/change-approvals");
    }

    @Test
    void approve_shouldReturnDefaultApprovalData_whenEnvelopeIsNull() {
        // given
        when(sapiRestClient.post()).thenReturn(requestBodyUriSpec);
        when(requestBodyUriSpec.uri(anyString())).thenReturn(requestBodySpec);
        when(requestBodySpec.body(any())).thenReturn(requestBodySpec);
        when(requestBodySpec.accept(MediaType.APPLICATION_JSON)).thenReturn(requestBodySpec);
        when(requestBodySpec.retrieve()).thenReturn(responseSpec);

        // envelope returned as null -> pendingChangeVo becomes null -> getApprovalData(null) returns empty object
        when(responseSpec.body(any(ParameterizedTypeReference.class))).thenReturn(null);

        // when
        ApprovalResponse response = service.approve(new com.hsbc.ccaas.papi.controller.model.ApproveChangeRequest());

        // then
        assertNotNull(response);
        assertNotNull(response.getData());

        ApprovalData approvalData = response.getData();

        // default ApprovalData object should have nulls (based on your method)
        assertNull(approvalData.getChangeIdentifier());
        assertNull(approvalData.getSuccessIndicator());
        assertNull(approvalData.getNewStatusCode());
        assertNull(approvalData.getMessageText());
        assertNull(approvalData.getAppliedDateTime());
        assertNull(approvalData.getEscalatedDateTime());

        verify(requestBodyUriSpec).uri("/sapi/v1/change-approvals");
    }
}
